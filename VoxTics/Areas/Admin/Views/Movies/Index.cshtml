@model VoxTics.Helpers.PaginatedList<VoxTics.Areas.Admin.ViewModels.Movie.MovieListItemViewModel>

@{
    ViewData["Title"] = "Movies";
    // Friendly helpers (read from ViewData/ViewBag whichever you used)
    var currentSearch = (ViewData["CurrentSearch"] ?? ViewBag.search ?? string.Empty)?.ToString();
    var sortColumn = (ViewData["SortColumn"] ?? ViewBag.sortColumn ?? string.Empty)?.ToString();
    object sortDescObj = ViewData["SortDesc"] ?? ViewBag.sortDescending;
    bool sortDescending = false;
    if (sortDescObj != null)
    {
        bool.TryParse(sortDescObj.ToString(), out sortDescending);
    }
}

@* Styles are now included in the unified design system *@

<div class="movies-container">
    <header class="movies-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-film"></i>
                Movies Management
            </h1>
            <div class="header-stats">
                <span class="total-count">@Model.TotalCount Total</span>
            </div>
        </div>
    </header>

    <!-- Alert Messages -->
    <div class="alerts-container">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success fade-in" role="alert">
                <i class="fas fa-check-circle"></i>
                @TempData["Success"]
                <button type="button" class="alert-close" data-dismiss="alert">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger fade-in" role="alert">
                <i class="fas fa-exclamation-circle"></i>
                @TempData["Error"]
                <button type="button" class="alert-close" data-dismiss="alert">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        }
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="search-section">
            <form method="get" asp-action="Index" class="search-form" role="search" aria-label="Search movies">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text"
                           name="search"
                           value="@currentSearch"
                           class="search-input"
                           placeholder="Search movies by title, genre, or description..."
                           autocomplete="off" />
                    <button type="button" class="clear-search" title="Clear search" style="@(string.IsNullOrWhiteSpace(currentSearch) ? "display: none;" : "")">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <input type="hidden" name="sortColumn" value="@sortColumn" />
                <input type="hidden" name="sortDescending" value="@(sortDescending.ToString().ToLower())" />
                <button type="submit" class="btn btn-search">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </form>
        </div>

        <div class="action-section">
            <a class="btn btn-primary btn-add-movie" asp-action="Create">
                <i class="fas fa-plus"></i>
                Add New Movie
            </a>

            <div class="view-controls">
                <div class="btn-group view-toggle" role="group" aria-label="View toggle">
                    <button id="cardViewBtn" type="button" class="btn btn-view active" data-view="cards">
                        <i class="fas fa-th-large"></i>
                        <span class="btn-text">Cards</span>
                    </button>
                    <button id="tableViewBtn" type="button" class="btn btn-view" data-view="table">
                        <i class="fas fa-list"></i>
                        <span class="btn-text">Table</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        @if (!Model.Items.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-film"></i>
                </div>
                <h3 class="empty-title">No movies found</h3>
                <p class="empty-message">
                    @if (!string.IsNullOrWhiteSpace(currentSearch))
                    {
                        <span>No movies match your search for "<strong>@currentSearch</strong>"</span>
                        <br />
                        <button class="btn btn-link btn-clear-search">Clear search to see all movies</button>
                    }
                    else
                    {
                        <span>There are no movies in the system yet.</span>
                        <br />
                        <a class="btn btn-primary" asp-action="Create">Add your first movie</a>
                    }
                </p>
            </div>
        }
        else
        {
            <!-- Card View -->
            <div id="cardView" class="movies-grid">
                <div class="loading-overlay">
                    <div class="spinner"></div>
                </div>

                @* Featured movie (first) *@
                @{
                    var featured = Model.Items.First();
                }
                <div class="featured-movie">
                    @await Html.PartialAsync("~/Areas/Admin/Views/Movies/_MovieCards.cshtml", featured)
                </div>

                <div class="movies-grid-container">
                    @foreach (var movie in Model.Items.Skip(1))
                    {
                        <div class="movie-card-wrapper">
                            @await Html.PartialAsync("~/Areas/Admin/Views/Movies/_MovieCards.cshtml", movie)
                        </div>
                    }
                </div>
            </div>

            <!-- Table View (hidden by default) -->
            <div id="tableView" class="table-container" style="display: none;">
                <div class="table-wrapper">
                    <table class="movies-table">
                        <thead>
                            <tr>
                                <th class="poster-col">Poster</th>
                                <th class="sortable @(sortColumn == "Title" ? (sortDescending ? "sort-desc" : "sort-asc") : "")">
                                    <a asp-action="Index"
                                       asp-route-sortColumn="Title"
                                       asp-route-sortDescending="@(sortColumn == "Title" ? (!sortDescending).ToString().ToLower() : "false")"
                                       asp-route-search="@currentSearch"
                                       class="sort-link">
                                        Title
                                        <i class="fas fa-sort sort-icon"></i>
                                    </a>
                                </th>
                                <th>Category</th>
                                <th class="showtimes-col">Showtimes</th>
                                <th class="sortable @(sortColumn == "Price" ? (sortDescending ? "sort-desc" : "sort-asc") : "")">
                                    <a asp-action="Index"
                                       asp-route-sortColumn="Price"
                                       asp-route-sortDescending="@(sortColumn == "Price" ? (!sortDescending).ToString().ToLower() : "false")"
                                       asp-route-search="@currentSearch"
                                       class="sort-link">
                                        Price
                                        <i class="fas fa-sort sort-icon"></i>
                                    </a>
                                </th>
                                <th>Status</th>
                                <th class="actions-col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var movie in Model.Items)
                            {
                                @await Html.PartialAsync("~/Areas/Admin/Views/Movies/_MovieTable.cshtml", movie)
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Enhanced Pagination -->
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    <span class="results-count">
                        Showing <strong>@((Model.PageIndex - 1) * Model.PageSize + 1)</strong> to
                        <strong>@Math.Min(Model.PageIndex * Model.PageSize, Model.TotalCount)</strong> of
                        <strong>@Model.TotalCount</strong> movies
                        @if (!string.IsNullOrWhiteSpace(currentSearch))
                        {
                            <span class="search-context"> for "<strong>@currentSearch</strong>"</span>
                        }
                    </span>
                </div>

                <nav class="pagination-nav" aria-label="Movies pagination">
                    <ul class="pagination">
                        @if (Model.PageIndex > 1)
                        {
                            <li class="page-item">
                                <a class="page-link prev-link"
                                   asp-action="Index"
                                   asp-route-page="@(Model.PageIndex - 1)"
                                   asp-route-search="@currentSearch"
                                   asp-route-sortColumn="@sortColumn"
                                   asp-route-sortDescending="@sortDescending"
                                   title="Previous page">
                                    <i class="fas fa-chevron-left"></i>
                                    <span>Previous</span>
                                </a>
                            </li>
                        }

                        @{
                            var start = Math.Max(1, Model.PageIndex - 2);
                            var end = Math.Min(Model.TotalPages, Model.PageIndex + 2);

                            if (start > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Index" asp-route-page="1" asp-route-search="@currentSearch" asp-route-sortColumn="@sortColumn" asp-route-sortDescending="@sortDescending">1</a>
                                </li>
                                if (start > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link ellipsis">…</span>
                                    </li>
                                }
                            }
                        }

                        @for (int i = start; i <= end; i++)
                        {
                            if (i == Model.PageIndex)
                            {
                                <li class="page-item active" aria-current="page">
                                    <span class="page-link current">@i</span>
                                </li>
                            }
                            else
                            {
                                <li class="page-item">
                                    <a class="page-link"
                                       asp-action="Index"
                                       asp-route-page="@i"
                                       asp-route-search="@currentSearch"
                                       asp-route-sortColumn="@sortColumn"
                                       asp-route-sortDescending="@sortDescending">@i</a>
                                </li>
                            }
                        }

                        @if (end < Model.TotalPages)
                        {
                            if (end < Model.TotalPages - 1)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link ellipsis">…</span>
                                </li>
                            }
                            <li class="page-item">
                                <a class="page-link" asp-action="Index" asp-route-page="@Model.TotalPages" asp-route-search="@currentSearch" asp-route-sortColumn="@sortColumn" asp-route-sortDescending="@sortDescending">@Model.TotalPages</a>
                            </li>
                        }

                        @if (Model.PageIndex < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link next-link"
                                   asp-action="Index"
                                   asp-route-page="@(Model.PageIndex + 1)"
                                   asp-route-search="@currentSearch"
                                   asp-route-sortColumn="@sortColumn"
                                   asp-route-sortDescending="@sortDescending"
                                   title="Next page">
                                    <span>Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>
@section Scripts {
    <script src="~/js/admin/movies/movies-index.js" asp-append-version="true"></script>
}