@using VoxTics.Helpers
@using VoxTics.Models.ViewModels
@model IEnumerable<MovieVM>

@{
    ViewData["Title"] = "Movies";
    var paginated = ViewData["Paginated"] as PaginatedList<VoxTics.Models.Entities.Movie>;
    var search = ViewData["Search"] as string;
    var categoryId = ViewData["CategoryId"] as int?;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Movies</h2>

    <form id="searchForm" class="d-flex" method="get" asp-action="Index" asp-controller="Movies">
        <input type="search" name="search" value="@search" class="form-control me-2" placeholder="Search movies..." />
        <input type="hidden" name="categoryId" value="@(categoryId.HasValue? categoryId.Value.ToString() : "")" />
        <button type="submit" class="btn btn-outline-primary">Search</button>
    </form>
</div>

<div id="moviesContainer">
    @Html.Partial("_MovieCards", Model)
</div>

@if (paginated != null && paginated.TotalPages > 1)
{
    <partial name="~/Views/Shared/_Pagination.cshtml" model="paginated" />
}

<!-- Details modal (AJAX) -->
<div class="modal fade" id="movieDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="movieDetailsContent"></div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Ajax submit for search -> reload cards only
            $("#searchForm").on("submit", function (e) {
                e.preventDefault();
                const query = $(this).serialize();
                $.get("@Url.Action("Index", "Movies")", query, function (html) {
                    const newHtml = $(html).find("#moviesContainer").html();
                    if (newHtml) $("#moviesContainer").html(newHtml);
                }).fail(function () {
                    alert('Failed to load movies.');
                });
            });

            // Open details in modal via AJAX (delegated)
            $(document).on("click", ".btn-details", function (e) {
                e.preventDefault();
                const url = $(this).attr("href");
                $.get(url)
                    .done(function (html) {
                        $("#movieDetailsContent").html(html);
                        var modal = new bootstrap.Modal(document.getElementById('movieDetailsModal'));
                        modal.show();
                    })
                    .fail(function () {
                        alert('Failed to load details.');
                    });
            });
        })();
    </script>
}
